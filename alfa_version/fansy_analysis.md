# Анализ legacy-системы Fansy и ошибки OP_P_NDFL_PRC_BODY

**Дата анализа:** 19 января 2026  
**Система:** Fansy (Pascal + FANSY-SCRIPT)  
**СУБД:** Firebird 2.5

---

## 1. Обзор архитектуры

### 1.1. Трёхслойная архитектура Fansy

```
┌─────────────────────────────────────────────────────────────┐
│  GUI LAYER (Приложения)                                     │
│  SPECTRE, TRUST, DEPO, REESTR, STANDARD, ADMIN, BALTUN     │
│  - Интерфейс пользователя                                   │
│  - События и навигация                                       │
│  - Вызов бизнес-функций                                      │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────────┐
│  META LAYER (Бизнес-логика и метаданные)                    │
│  Базы: META, ADM_META                                        │
│  - FANSY-SCRIPT функции (DICMETAF)                          │
│  - Формы (DICFORMS)                                          │
│  - Выборки (DICSELEC)                                        │
│  - Бизнес-правила                                            │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────────┐
│  DATA LAYER (Данные)                                         │
│  База: DATA                                                  │
│  - Документы (OD_DOCS, OD_DOLS)                             │
│  - Проводки (OD_TURNS, OD_WIRING)                           │
│  - Остатки (OD_RESTS)                                        │
│  - Справочники (D_*)                                         │
└─────────────────────────────────────────────────────────────┘
```

### 1.2. Ключевые компоненты

#### META база (Метаданные)
- **DICMETAF** - хранение тел функций FANSY-SCRIPT
- **DICFORMS** - описание форм документов
- **DICSELEC** - SQL-запросы и выборки данных
- **DICFIELD** - описание полей
- **DICAPPL** - приложения системы

#### DATA база (Бизнес-данные)
- **OD_DOCS** - заголовки документов
- **OD_DOLS** - позиции документов
- **OD_TURNS** - обороты по счетам
- **OD_WIRING** - проводки
- **OD_RESTS** - остатки
- **OD_STEPS** - шаги выполнения директив

---

## 2. Детальный анализ ошибки OP_P_NDFL_PRC_BODY

### 2.1. Описание проблемы

**Текст ошибки:** "Не все входные параметры означены"  
**Место возникновения:** Строка 2192 функции `OP_P_NDFL_PRC_BODY`  
**Проблемный вызов:**
```fansy-script
FROM_PAY:=_F_SPECTRE->Get_NDFL_Nach(old_b_date, iif((NDFL_TYPE>=2) and (Date(E_DATE)=Date(D_DATE)),d_date,e_date), INVESTOR, CONTRACT, NAL_PER, _F_SPECTRE.Get_NAL_PER.KBK1, FALSE, IS_ALF);
```

**Количество переданных параметров:** 8

### 2.2. Контекст вызова

Функция вызывается в контексте расчёта НДФЛ (налога на доходы физических лиц):

```fansy-script
// Линия 2192-2193: Расчёт начисленного налога минус возвращённый
FROM_PAY:=_F_SPECTRE->Get_NDFL_Nach(old_b_date, iif((NDFL_TYPE>=2) and (Date(E_DATE)=Date(D_DATE)),d_date,e_date), INVESTOR, CONTRACT, NAL_PER, _F_SPECTRE.Get_NAL_PER.KBK1, FALSE, IS_ALF);
FROM_ADD:=_F_SPECTRE->Get_NDFL_Nach(old_b_date, iif((NDFL_TYPE>=2) and (Date(E_DATE)=Date(D_DATE)),d_date,e_date), INVESTOR, CONTRACT, NAL_PER, _F_SPECTRE.Get_NAL_PER.KBK2, FALSE, IS_ALF);
```

### 2.3. Анализ параметров

| № | Значение | Тип | Назначение |
|---|----------|-----|------------|
| 1 | `old_b_date` | DATE | Начальная дата периода |
| 2 | `iif((NDFL_TYPE>=2)...)` | DATE | Конечная дата периода (условная) |
| 3 | `INVESTOR` | INT | ID инвестора/налогоплательщика |
| 4 | `CONTRACT` | INT/STRING | Номер договора |
| 5 | `NAL_PER` | INT | Налоговый период |
| 6 | `_F_SPECTRE.Get_NAL_PER.KBK1` | STRING | КБК (код бюджетной классификации) |
| 7 | `FALSE` | BOOLEAN | Флаг (возможно, для детализации) |
| 8 | `IS_ALF` | BOOLEAN | Признак базы ALF |

### 2.4. Гипотезы о причине ошибки

**Основная гипотеза:** Сигнатура функции `Get_NDFL_Nach` была изменена в октябре 2025 года, но не все вызовы были обновлены.

**Возможные варианты:**
1. **Добавлен новый обязательный параметр** (например, флаг учёта вычетов по ИИС)
2. **Изменён порядок параметров**
3. **Изменён тип одного из параметров**
4. **Добавлен параметр для нового функционала** (например, TAX_DED_EX, который рассчитывается строкой выше)

**Подтверждающие факты:**
- Строкой выше (2184) появился расчёт `TAX_DED_EX` с комментарием "учитываем вычеты по ИИС EAN 11.01.2025 заявка 51157"
- Дата заявки (11.01.2025) близка к предполагаемому времени изменения функции
- В строке 2185 закомментирован старый способ расчёта вычетов

### 2.5. Затронутые данные

**Документ-источник:**
- **doc_id:** 4734767
- **Таблица:** OD_DOCS

**Директива:**
- **dir_id:** 4734776  
- **Таблица:** OD_STEPS

**Связанные данные:**
- OD_TURNS (обороты по счетам)
- OD_RESTS (остатки)
- OD_WIRING (проводки)
- U_OP_P_NDFL (специфичная таблица для расчёта НДФЛ)
- OD_NDFL (начисления НДФЛ)

---

## 3. Синтаксис FANSY-SCRIPT

### 3.1. Основные конструкции

#### Объявление функции
```fansy-script
//FunctionName(%param1:type, %param2:type) //== Описание
uses _F_MODULE1, _F_MODULE2;
var LOCAL_VAR1, LOCAL_VAR2;
```

#### Использование модулей
```fansy-script
uses _F_BUX,_F_DOC,_F_SPECTRE;
```

Модули представляют собой наборы функций:
- **_F_BUX** - бухгалтерское ядро
- **_F_DOC** - документооборот  
- **_F_SPECTRE** - специфичные функции (в т.ч. расчёт НДФЛ)
- **_F_REPORT** - отчёты

#### Вызов методов модулей
```fansy-script
// Синтаксис: MODULE->Function(params)
result := _F_SPECTRE->Get_NDFL_Nach(param1, param2, ...);

// Доступ к свойствам метода:
kbk := _F_SPECTRE.Get_NAL_PER.KBK1;
```

#### Переменные
```fansy-script
var NUM, D_DATE, WHOS;           // Простые переменные
var COUNTER:=1;                   // С инициализацией
var IS_ALF:=(MyBase='ALF');      // С вычислением
```

#### Циклы и условия
```fansy-script
// Цикл по выборке SQL
for 'Данные' select [SELECT ...] 
from %Doc_ID
into VAR1, VAR2 do
    // код
end;

// Условие
if CONDITION then
    // код
elsif ANOTHER_CONDITION then
    // код
else
    // код
end;
```

### 3.2. Специфические особенности

1. **Параметры функций** передаются через `%param_name`
2. **Комментарии:** `//` и `/* */`
3. **Строковые литералы:** одинарные кавычки `'текст'`
4. **Оператор присваивания:** `:=`
5. **Конкатенация строк:** `+`
6. **Встроенные функции:** `Str()`, `Date()`, `iif()`, `IsNull()`, `Clear()`, и др.

---

## 4. План действий по устранению ошибки

### 4.1. Немедленные действия

1. **Найти актуальную сигнатуру функции `Get_NDFL_Nach`**
   - Запрос к META.DICMETAF где FUNC_NAME = 'Get_NDFL_Nach' и APP_NUM связан с '_F_SPECTRE'
   - Анализ заголовка функции и параметров

2. **Сравнить с вызовами**
   - Найти все места вызова Get_NDFL_Nach в системе
   - Сравнить количество и типы параметров

3. **Исправить вызов в OP_P_NDFL_PRC_BODY**
   - Добавить недостающий параметр (вероятно, TAX_DED_EX)
   - Обновить FUNC_BODY в DICMETAF

### 4.2. Среднесрочные действия

1. **Создать инструмент для проверки совместимости**
   - Парсер FANSY-SCRIPT для извлечения сигнатур функций
   - Анализатор вызовов функций
   - Проверка соответствия параметров

2. **Документировать все изменения функций**
   - История изменений с датами
   - Changelog для каждой функции
   - Миграционные инструкции

### 4.3. Долгосрочные действия

1. **Внедрить контроль версий**
   - Хранение старых версий FUNC_BODY
   - Таблица истории изменений метаданных
   - Автоматические тесты совместимости

2. **Создать статический анализатор**
   - Проверка типов параметров
   - Предупреждения о несовместимости
   - Рекомендации по рефакторингу

---

## 5. Инструментарий для анализа

### 5.1. Парсер логов ошибок

Создан Python-скрипт для:
- Парсинга текстовых логов ошибок
- Извлечения информации о функции, строке, параметрах
- Связывания с метаданными из META

### 5.2. Анализатор зависимостей

Для понимания потоков данных:
- Граф вызовов функций
- Граф зависимостей таблиц
- Визуализация через Mermaid

### 5.3. Симулятор вызовов

Для тестирования изменений:
- Проверка типов параметров
- Валидация значений
- Предсказание результата

---

## 6. Ключевые выводы

1. **Проблема типична** для legacy-систем без строгой типизации и версионирования
2. **Риск каскадных ошибок** при изменении сигнатур функций высок
3. **Необходим инструментарий** для автоматической проверки совместимости
4. **Документация критична** для понимания изменений и их последствий
5. **Требуется рефакторинг** подхода к управлению изменениями

---

## 7. Следующие шаги

### Приоритет 1: Устранение текущей ошибки
- [ ] Получить определение Get_NDFL_Nach из META
- [ ] Исправить вызовы в OP_P_NDFL_PRC_BODY
- [ ] Протестировать на тестовых данных
- [ ] Развернуть в продакшн

### Приоритет 2: Предотвращение повторения
- [ ] Создать каталог всех функций с сигнатурами
- [ ] Внедрить проверку при изменении функций
- [ ] Добавить юнит-тесты для критичных функций

### Приоритет 3: Улучшение процессов
- [ ] Разработать стандарт документирования изменений
- [ ] Создать систему контроля версий метаданных
- [ ] Обучить команду лучшим практикам

---

**Автор анализа:** Claude (Anthropic)  
**Источники:** PROGRAM.pdf, meta_base_structure_UTF-8.txt, OP_P_NDFL_PRC_BODY.txt
